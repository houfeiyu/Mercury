/* 2018-1-8 08:17:08 | 版权所有 合肥火星科技有限公司 http://www.marsgis.cn  【联系我们QQ：516584683】 */
var mapSwipeWidget=L.widget.bindClass(L.widget.BaseWidget.extend({map:null,options:{resources:["view.css"],view:{type:"append",url:"view.html",parent:"body"}},winCreateOK:function(e,a){for(var i=this,t="",n="",r=this.getBaseMaps(),s=0;s<r.length;s++){var o=r[s];t+=' <li><a href="javascript:mapSwipeWidget.changeSelectBaseLayer('+s+',true)">'+o.name+"</a></li>",n+=' <li><a href="javascript:mapSwipeWidget.changeSelectSwipeLayer('+s+',true)">'+o.name+"</a></li>"}$("#ddl_basemap").html(t),$("#ddl_swipelayer").html(n),this.changeSelectBaseLayer(0,!1),this.changeSelectSwipeLayer(1,!1),$("#btn_mapSwipe_sp").click(function(){i.changeSwipe("2")}),$("#btn_mapSwipe_cz").click(function(){i.changeSwipe("1")}),$("#btn_mapSwipe_close").click(function(){i.disableBase()})},layerSwipe:null,layerBase:null,arrOldLayers:[],activate:function(){this.swipeType="1";var e=this;this.mapPageCustomer.create({parent:"#centerDiv",onChange:function(a){e.clip()}}),this.mapPageCustomer2.create({parent:"#centerDiv",onChange:function(a){e.clip()}}),this.mapPageCustomer2.hide();var a=[];this.map.eachLayer(function(e){e instanceof L.TileLayer&&a.push(e)}),$.each(a,function(a,i){e.map.removeLayer(i)}),this.arrOldLayers=a;var i=this.getBaseMaps();null!=this.layerBase?this.map.addLayer(this.layerBase):(this.layerBase=i[0]._layer,this.map.addLayer(this.layerBase)),null!=this.layerSwipe?this.map.addLayer(this.layerSwipe):(this.layerSwipe=i[1]._layer,this.map.addLayer(this.layerSwipe)),this.map.on("move",this.clip,this),this.clip();var e=this;setTimeout(function(){e.updateBaseLayer(e.layerBase)},500)},disable:function(){this.map.off("move",this.clip,this),$("#map").height("100%"),this.removeSwipeLayer(),this.layerSwipe=null,this.layerBase=null;var e=this;$.each(this.arrOldLayers,function(a,i){e.map.addLayer(i)}),this.arrOldLayers=[],this.mapPageCustomer.remove(),this.mapPageCustomer2.remove()},removeSwipeLayer:function(){if(null!=this.layerBase&&this.map.removeLayer(this.layerBase),null!=this.layerSwipe){var e=this.map.containerPointToLayerPoint([0,0]),a=this.map.containerPointToLayerPoint(this.map.getSize()),i="rect("+[e.y,a.x,a.y,e.x].join("px,")+"px)";this.clipLayer(this.layerSwipe,i),this.map.removeLayer(this.layerSwipe)}},clip:function(){if(null!=this.layerSwipe){var e,a,i=this.map.containerPointToLayerPoint([0,0]),t=this.map.containerPointToLayerPoint(this.map.getSize());"1"==this.swipeType?(e=t.x,a=i.y+(t.y-i.y)*Number(this.mapPageCustomer.$range.val())):(e=i.x+(t.x-i.x)*Number(this.mapPageCustomer2.$range.val()),a=t.y);var n="rect("+[i.y,e,a,i.x].join("px,")+"px)";this.clipLayer(this.layerSwipe,n)}},clipLayer:function(e,a){var i=this;e instanceof L.LayerGroup||e instanceof L.FeatureGroup?e.eachLayer(function(e){i.clipLayer(e,a)}):e.getContainer().style.clip=a},swipeType:"1",changeSwipe:function(e){this.swipeType=e,"1"==e?(this.mapPageCustomer.show(),this.mapPageCustomer2.hide()):(this.mapPageCustomer.hide(),this.mapPageCustomer2.show()),this.clip()},mapPageCustomer:{onChangeFun:null,$parent:null,$drag:null,$range:null,create:function(e){this.remove(),this.$parent=$(e.parent),this.onChangeFun=e.onChange;var a='<div id="dragSwipe" style="position: absolute;left: 0px;height: 1px; background: rgb(214, 214, 214); width: 100%; border-top: 1px solid rgb(170, 170, 170); border-bottom: 1px solid rgb(170, 170, 170); z-index: 400;"><div style="width: 168px; height: 5px; margin: auto; background: #999;cursor: s-resize;"></div><input id="rangeSwipe" class="range" type="range" min="0" max="1.0" step="any" style="display: none;z-index:-1;"></div>';this.$parent.append(a),this.$drag=$("#dragSwipe"),this.$range=$("#rangeSwipe"),this.$drag.css({top:this.$parent.height()/2+"px"}),this.isMobile()?this.targetMoveTBHandle():this.targetMoveHandle();var i=this.$parent.height(),t=this.$drag[0].offsetTop;this.$range.val(t/i)},show:function(){this.$drag.show()},hide:function(){this.$drag.hide()},remove:function(){this.$drag&&(this.$drag.remove(),this.$drag=null),this.$range&&(this.$range.remove(),this.$range=null)},isMobile:function(){return!!navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)},targetMoveHandle:function(){var e=this;this.$drag.bind("mousedown",function(a){var i=e.$parent.height(),t=e.$drag[0].offsetTop,n=a.pageY,r=0;$(document).bind("mousemove",function(a){var s=a.pageY-n,o=t+s;if(o>0&&o<i-r){var h=t+s+r;e.$drag.css({top:h+"px"}),e.$range.val(h/i),e.onChangeFun()}})}),$(document).bind("mouseup",function(){$(this).unbind("mousemove")})},targetMoveTBHandle:function(){this.$drag.bind("touchstart",function(e){var a=$this.$parent.height(),i=this.$drag[0].offsetTop,t=e.originalEvent.targetTouches[0],n=t.pageY,r=0;this.$drag.bind("touchmove",function(e){var t=e.originalEvent.targetTouches[0],s=t.pageY-n,o=i+s;if(o>0&&o<a-r){var h=i+s+r;$(obj1).css({top:h+"px"}),$this.$range.val(h/a),$this.onChangeFun()}})}),$(obj1).bind("touchup",function(){$(this).unbind("touchmove")})}},mapPageCustomer2:{onChangeFun:null,$parent:null,$drag:null,$range:null,create:function(e){this.remove(),this.$parent=$(e.parent),this.onChangeFun=e.onChange;var a='<div id="dragSwipe2" style="position: absolute; top: 0px; width: 1px; background: rgb(214, 214, 214); height: 100%; border-left: 1px solid rgb(170, 170, 170); border-right: 1px solid rgb(170, 170, 170); z-index: 400; padding-top: 324px; display: block;"><div style="height: 168px; width: 5px; margin: auto; background: #999;cursor: e-resize;"></div><input id="rangeSwipe2" class="range" type="range" min="0" max="1.0" step="any" style="display:none; z-index:-1;"></div>';this.$parent.append(a),this.$drag=$("#dragSwipe2"),this.$range=$("#rangeSwipe2"),this.$drag.css({"padding-top":(this.$parent.height()-168)/2+"px",left:this.$parent.width()/2+"px"}),this.isMobile()?this.targetMoveTBHandle():this.targetMoveHandle();var i=this.$parent.width(),t=this.$drag[0].offsetLeft;this.$range.val(t/i)},show:function(){this.$drag.show()},hide:function(){this.$drag.hide()},remove:function(){this.$drag&&(this.$drag.remove(),this.$drag=null),this.$range&&(this.$range.remove(),this.$range=null)},isMobile:function(){return!!navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)},targetMoveHandle:function(){var e=this;this.$drag.bind("mousedown",function(a){var i=e.$parent.width(),t=0,n=e.$drag[0].offsetLeft,r=a.pageX;$(document).bind("mousemove",function(a){var s=a.pageX-r,o=n+s;if(o>0&&o<i-t){var h=n+s+t;e.$drag.css({left:h+"px"}),e.$range.val(h/i),e.onChangeFun()}})}),$(document).bind("mouseup",function(){$(this).unbind("mousemove")})},targetMoveTBHandle:function(e,a,i){var e=this;this.$drag.bind("touchstart",function(a){var i=e.$parent.width(),t=0,n=e.$drag[0].offsetLeft,r=a.originalEvent.targetTouches[0],s=r.pageX;e.$drag.bind("touchmove",function(a){var r=a.originalEvent.targetTouches[0],o=r.pageX-s,h=n+o;if(h>0&&h<i-t){var p=n+o+t;e.$drag.css({left:p+"px"}),e.$range.val(p/i),e.onChangeFun()}})}),$(a).bind("touchup",function(){$(this).unbind("touchmove")})}},_basemaps:null,getBaseMaps:function(){if(null==this._basemaps){for(var e=this.map.gisdata.config.basemaps,a=[],i=0;i<e.length;i++){var t=e[i];null!=t.crs&&t.crs!=this.map.gisdata.config.crs||a.push(t)}this._basemaps=a}return this._basemaps},updateBaseLayer:function(e){this.removeSwipeLayer(),this.layerBase=e,this.map.addLayer(this.layerBase),null!=this.layerSwipe&&this.map.addLayer(this.layerSwipe),this.clip()},updateSwipeLayer:function(e){this.removeSwipeLayer(),this.layerSwipe=e,null!=this.layerBase&&this.map.addLayer(this.layerBase),this.map.addLayer(this.layerSwipe),this.clip()},_last_baselayer_id:null,_last_swipeLayer_id:null,changeSelectBaseLayer:function(e,a){if(this._last_swipeLayer_id==e)return void layer.msg("底图与卷帘图层不能为同一图层！");this._last_baselayer_id=e;var i=this.getBaseMaps(),t=i[e];$("#btnSelectBaseMap").html("已选:"+t.name+'<span class="caret"></span>'),a&&this.updateBaseLayer(t._layer)},changeSelectSwipeLayer:function(e,a){if(this._last_baselayer_id==e)return void layer.msg("底图与卷帘图层不能为同一图层！");this._last_swipeLayer_id=e;var i=this.getBaseMaps(),t=i[e];$("#btnSelectSwipelayer").html("已选:"+t.name+'<span class="caret"></span>'),a&&this.updateSwipeLayer(t._layer)}}));