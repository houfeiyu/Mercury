/* 2017-7-28 11:45:44 | 版权所有 合肥火星科技有限公司 http://www.marsgis.cn  【联系我们QQ：516584683】 */
!function(t,e){"function"==typeof define&&define.amd?define(["leaflet"],t):"object"==typeof exports&&(module.exports=t(require("leaflet")),module.exports=t(require("jquery"))),"undefined"!=typeof e&&e.L&&(e.L.mapVLayer=t(L))}(function(t){function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}t.Map.include({latLngToAccurateContainerPoint:function(e){var n=this.project(t.latLng(e)),i=n._subtract(this.getPixelOrigin());return t.point(i).add(this._getMapPanePos())}});var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),o=function c(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:c(a,e,n)}if("value"in i)return i.value;var o=i.get;if(void 0!==o)return o.call(n)},s=mapv.baiduMapLayer?mapv.baiduMapLayer.__proto__:Function,r=function(r){function c(t,i,a,o){if(e(this,c),!s)return n(r);var r=n(this,(c.__proto__||Object.getPrototypeOf(c)).call(this,t,a,o)),u=r;o=o||{},u.init(o),u.argCheck(o),r.canvasLayer=i,r.clickEvent=r.clickEvent.bind(r),r.mousemoveEvent=r.mousemoveEvent.bind(r);var h=r.moveStartEvent.bind(r),d=r.moveEndEvent.bind(r),l=r.zoomStartEvent.bind(r);return r.map.on("movestart",h),r.map.on("moveend",d),r.map.on("zoomstart",l),r._dispose=!1,r.unbindMapEvent=function(){r.map.off("movestart",h),r.map.off("moveend",d),r.map.off("zoomstart",l)},r.bindEvent(),r}return i(c,r),a(c,[{key:"dispose",value:function(t){this._dispose=!0,this.unbindEvent(),this.unbindMapEvent(),this.clear()}},{key:"clickEvent",value:function(t){var e=t.layerPoint;o(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"clickEvent",this).call(this,e,t)}},{key:"mousemoveEvent",value:function(t){var e=t.layerPoint;o(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"mousemoveEvent",this).call(this,e,t)}},{key:"bindEvent",value:function(t){var e=this.map;this.options.methods&&(this.options.methods.click&&e.on("click",this.clickEvent),this.options.methods.mousemove&&e.on("mousemove",this.mousemoveEvent))}},{key:"unbindEvent",value:function(t){var e=this.map;this.options.methods&&(this.options.methods.click&&e.off("click",this.clickEvent),this.options.methods.mousemove&&e.off("mousemove",this.mousemoveEvent))}},{key:"getContext",value:function(){return this.canvasLayer.getCanvas().getContext(this.context)}},{key:"addData",value:function(t,e){var n=t;t&&t.get&&(n=t.get()),this.dataSet.add(n),this.update({options:e})}},{key:"updateData",value:function(t,e){var n=t;t&&t.get&&(n=t.get()),this.dataSet.set(n),this.update({options:e})}},{key:"getData",value:function(){return this.dataSet}},{key:"removeData",value:function(t){if(this.dataSet){var e=this.dataSet.get(t);this.dataSet.set(e),this.update({options:null})}}},{key:"clearData",value:function(){this.dataSet&&this.dataSet.clear(),this.update({options:null})}},{key:"_canvasUpdate",value:function(e){if(!this._dispose&&this.canvasLayer){var n=this,i=n.options.animation,a=this.getContext(),o=this.map;if(n.isEnabledTime()){if(void 0===e)return void this.clear(a);"2d"===this.context&&(a.save(),a.globalCompositeOperation="destination-out",a.fillStyle="rgba(0, 0, 0, .1)",a.fillRect(0,0,a.canvas.width,a.canvas.height),a.restore())}else this.clear(a);if("2d"===this.context)for(var s in n.options)a[s]=n.options[s];else a.clear(a.COLOR_BUFFER_BIT);if(!(n.options.minZoom&&o.getZoom()<n.options.minZoom||n.options.maxZoom&&o.getZoom()>n.options.maxZoom)){var r=o.latLngToAccurateContainerPoint(this.canvasLayer.getTopLeft()),c={transferCoordinate:function(e){var n=o.latLngToAccurateContainerPoint(t.latLng(e[1],e[0])),i={x:n.x-r.x,y:n.y-r.y};return[i.x,i.y]}};void 0!==e&&(c.filter=function(t){var n=i.trails||10;return e&&t.time>e-n&&t.time<e});var u=n.dataSet.get(c);this.processData(u),n.options._size=n.options.size;var h=o.latLngToContainerPoint(t.latLng(0,0)),d={x:h.x-r.x,y:h.y-r.y};this.drawContext(a,new mapv.DataSet(u),n.options,d),n.options.updateCallback&&n.options.updateCallback(e)}}}},{key:"init",value:function(t){var e=this;e.options=t,this.initDataRange(t),this.context=e.options.context||"2d",e.options.zIndex&&this.canvasLayer&&this.canvasLayer.setZIndex(e.options.zIndex),this.initAnimator()}},{key:"addAnimatorEvent",value:function(){}},{key:"moveStartEvent",value:function(){var t=this.options.animation;this.isEnabledTime()&&this.animator&&(this.steps.step=t.stepsRange.start,this._hide())}},{key:"moveEndEvent",value:function(){this.canvasLayer.draw(),this._show()}},{key:"zoomStartEvent",value:function(){this._hide()}},{key:"clear",value:function(t){t&&t.clearRect&&t.clearRect(0,0,t.canvas.width,t.canvas.height)}},{key:"_hide",value:function(){this.canvasLayer.canvas.style.display="none"}},{key:"_show",value:function(){this.canvasLayer.canvas.style.display="block"}},{key:"draw",value:function(){this.canvasLayer.draw()}}]),c}(s);return t.MapVLayer=t.Layer.extend({initialize:function(e,n,i){i=i||{},this.dataSet=e||{},this.mapVOptions=n||{},this.render=this.render.bind(this),t.Util.setOptions(this,i),this.canvas=this._createCanvas(),t.stamp(this)},onAdd:function(e){this._map=e;var n=this.getPane(),i=this.container=t.DomUtil.create("div","leaflet-layer leaflet-zoom-animated",n);i.appendChild(this.canvas);var a=e.getSize();i.style.width=a.x+"px",i.style.height=a.y+"px",this.renderer=new r(e,this,this.dataSet,this.mapVOptions),this.draw(),this.fire("loaded")},_hide:function(){this.canvas.style.display="none"},_show:function(){this.canvas.style.display="block"},onRemove:function(e){t.DomUtil.remove(this.container),this.renderer.dispose(),e.off({moveend:this.draw,zoomstart:this._hide,zoomend:this._show},this)},addData:function(t,e){this.renderer.addData(t,e)},update:function(t,e){this.renderer.updateData(t,e)},getData:function(){return this.renderer&&(this.dataSet=this.renderer.getData()),this.dataSet},removeData:function(t){this.renderer&&this.renderer.removeData(t)},clearData:function(){this.renderer.clearData()},draw:function(){return this._reset()},setZIndex:function(t){this.canvas.style.zIndex=t},render:function(){this.renderer._canvasUpdate()},getCanvas:function(){return this.canvas},getContainer:function(){return this.container},getTopLeft:function(){var t,e=this._map;if(e){var n=e.getBounds();t=n.getNorthWest()}return t},_createCanvas:function(){var t=document.createElement("canvas");return t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.pointerEvents="none",t.style.zIndex=this.options.zIndex||600,t},_resize:function(){var e=this.canvas;if(e){var n=this._map,i=n.getSize();e.width=i.x,e.height=i.y,e.style.width=i.x+"px",e.style.height=i.y+"px";var a=n.getBounds(),o=n.latLngToLayerPoint(a.getNorthWest());t.DomUtil.setPosition(e,o)}},_reset:function(){this._resize(),this._render()},redraw:function(){this._resize(),this._render()},_render:function(){this.render()}}),t.mapVLayer=function(e,n,i){return new t.MapVLayer(e,n,i)},t.mapVLayer},window);