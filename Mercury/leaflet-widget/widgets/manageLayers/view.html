<!-- 2018-1-23 16:23:54 | 版权所有 合肥火星科技有限公司 http://www.marsgis.cn  【联系我们QQ：516584683】 -->
<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"><title></title><script src="../../../lib/include-lib.js?time=20180123" libpath="../../../lib/" include="jquery,font-awesome,bootstrap,jquery.range,ztree,layer,haoutil"></script><link href="../../css/widget-win.css" rel="stylesheet"><link href="view.css" rel="stylesheet"></head><body><div style="width:100%;height:100%;overflow-y:auto"><ul id="treeOverlays" class="ztree"></ul></div><div id="content_layer_manager_rMenu" class="layersctl_rMenu"><ul><li data-type="top">图层置为顶层</li><li data-type="up">图层上移一层</li><li data-type="down">图层下移一层</li><li data-type="bottom">图层置为底层</li></ul></div><script>function initWidgetView(e){thisWidget=e,bindRightMenuEvnet();var a={check:{enable:!0},data:{simpleData:{enable:!0}},callback:{onCheck:treeOverlays_onCheck,onRightClick:treeOverlays_OnRightClick},view:{addDiyDom:addOpacityRangeDom}},n=[];layers=thisWidget.getLayers();for(var r=layers.length-1;r>=0;r--){var t=layers[r],i={id:t.id,pId:t.pid,name:t.name,opacity:t.opacity,_key:t._key};null==t._layer?(i.icon="images/folder.png",i.open=null==t.open||t.open,n.push(i)):(i.icon="images/layer.png",i.checked=thisWidget.getLayerVisible(t._layer),t._parent&&(i._parent=t._parent._key),layersObj[i._key]=t._layer,n.push(i))}$.fn.zTree.init($("#treeOverlays"),a,n)}function treeOverlays_onCheck(e,a,n){for(var r=$.fn.zTree.getZTreeObj(a),t=r.getChangeCheckedNodes(),i=0;i<t.length;i++){var n=t[i];if(n.checkedOld=n.checked,layer=layersObj[n._key],null!=layer)if(n.checked?$("#"+n.tId+"_range").show():$("#"+n.tId+"_range").hide(),n._parent){var o=layersObj[n._parent];thisWidget.updateLayerVisible(layer,n.checked,o)}else thisWidget.updateLayerVisible(layer,n.checked)}}function addOpacityRangeDom(e,a){if("images/layer.png"==a.icon){var n=$("#"+a.tId),r='<input id="'+a.tId+'_range" type="range" style="width: 50px;" />';n.append(r),a.checked||$("#"+a.tId+"_range").hide(),$("#"+a.tId+"_range").range({min:0,max:100,step:1,value:100*(a.opacity||1),onChange:function(e){var n=e/100,r=layersObj[a._key];thisWidget.udpateLayerOpacity(r,n)}})}}function treeOverlays_OnRightClick(e,a,n){if(null!=layersObj[n._key]){lastRightClickTreeId=a,lastRightClickTreeNode=n;var r=e.clientY,t=e.clientX,i=document.body.offsetHeight-100,o=document.body.offsetWidth-100;r>i&&(r=i),t>o&&(t=o),$("#content_layer_manager_rMenu").css({top:r+"px",left:t+"px"}).show(),$("body").bind("mousedown",onBodyMouseDown)}}function onBodyMouseDown(e){"content_layer_manager_rMenu"==e.target.id||$(e.target).parents("#content_layer_manager_rMenu").length>0||hideRMenu()}function hideRMenu(){$("body").unbind("mousedown",onBodyMouseDown),$("#content_layer_manager_rMenu").hide()}function bindRightMenuEvnet(){$("#content_layer_manager_rMenu li").on("click",function(){hideRMenu();var e=$(this).attr("data-type");moveNodeAndLayer(e)})}function moveNodeAndLayer(e){var a,n=$.fn.zTree.getZTreeObj(lastRightClickTreeId),r=lastRightClickTreeNode.getParentNode();a=null==r?n.getNodes():r.children;var t=lastRightClickTreeNode,i=layersObj[t._key];switch(e){case"up":var o=t.getPreNode();if(o){n.moveNode(o,t,"prev");var d=layersObj[o._key];exchangeLayer(i,d)}break;case"top":if(0==t.getIndex())return;for(;t.getIndex()>0;){var o=t.getPreNode();if(o){n.moveNode(o,t,"prev");var d=layersObj[o._key];exchangeLayer(i,d)}}break;case"down":var o=t.getNextNode();if(o){n.moveNode(o,t,"next");var d=layersObj[o._key];exchangeLayer(i,d)}break;case"bottom":if(t.getIndex()==a.length-1)return;for(;t.getIndex()<a.length-1;){var o=t.getNextNode();if(o){n.moveNode(o,t,"next");var d=layersObj[o._key];exchangeLayer(i,d)}}}layers.sort(function(e,a){return e.order-a.order})}function exchangeLayer(e,a){var n=e.config.order;e.config.order=a.config.order,a.config.order=n,thisWidget.udpateLayerZIndex(e,e.config.order),thisWidget.udpateLayerZIndex(a,a.config.order)}function updateCheckd(e,a){var n=$.fn.zTree.getZTreeObj("treeOverlays"),r=n.getNodesByParam("name",e,null);r&&r.length>0?n.checkNode(r[0],a,!1):console.log("未在图层树上找到图层“"+e+"”，无法自动勾选处理")}var thisWidget,layers=[],layersObj={},lastRightClickTreeId,lastRightClickTreeNode</script></body></html>