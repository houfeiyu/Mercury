/* 2017-12-12 13:02:36 | 版权所有 合肥火星科技有限公司 http://www.marsgis.cn  【联系我们QQ：516584683】 */
function initWidgetView(t){thisWidget=t,$("#btn_plot_delall").click(function(){thisWidget.deleteAll()});var e=!0;$("#btn_plot_isedit").click(function(){e=!e,e?($(this).removeClass("active"),$(this).children().removeClass("fa-lock").addClass("fa-unlock")):($(this).addClass("active"),$(this).children().removeClass("fa-unlock").addClass("fa-lock")),thisWidget.hasEdit(e)}),plotFile.initEvent(),plotEdit.loadConfig()}var thisWidget,plotFile={initEvent:function(){var t,e=this;$("#btn_plot_openfile").click(function(){t=!0,$("#input_plot_file").click()}),$("#btn_plot_openfile2").click(function(){t=!1,$("#input_plot_file").click()}),$("#btn_plot_savefile").click(function(){var t=thisWidget.getGeoJson();null==t||""==t?haoutil.msg("当前未标绘任何数据！"):haoutil.file.downloadFile("我的标注.json",t)}),$("#input_plot_file").change(function(a){var l=this.files[0],i=l.name,n=i.substring(i.lastIndexOf(".")+1,i.length).toLowerCase();if("json"!=n)return haoutil.msg("文件类型不合法,请选择json格式标注文件！"),void e.clearPlotFile();if(window.FileReader){var s=new FileReader;s.readAsText(l,"UTF-8"),s.onloadend=function(a){var l=this.result;thisWidget.jsonToLayer(l,t),e.clearPlotFile()}}})},clearPlotFile:function(){window.addEventListener?document.getElementById("input_plot_file").value="":document.getElementById("input_plot_file").outerHTML+=""}},plotlist={bindSelList:function(){var t=this,e=$("#sel_plot_list");$.getJSON("config/plotlist.json",function(a){var l,i="";for(var n in a)i+='<option value="'+n+'">'+n+"("+a[n].length+")</option>",null==l&&(l=n);l&&(t.showPlotList(a[l]),e.attr("data-value",l)),e.html(i),e.select(),e.change(function(){var e=$(this).attr("data-value"),l=a[e];t.showPlotList(l)})})},_listData:null,showPlotList:function(t){this._listData=t;for(var e="",a=0;a<t.length;a++){var l,i=t[a];if(plotEdit.defval[i.type]){var n=plotEdit.defval[i.type];l=n.style.iconUrl}if(i.iconUrl&&(l=i.iconUrl),i.style&&i.style.iconUrl&&(l=i.style.iconUrl),l)e+=' <li onclick="plotlist.startPlot('+a+',this)"> <i title="'+i.name+'"  > <img src="../../'+l+'" style="max-width: 50px;max-height: 50px;" /></i></li>';else{var s,r="#000000";if(plotEdit.defval[i.type]){var n=plotEdit.defval[i.type];s=n.style.iconClass,r=n.style.color}i.iconClass&&(s=i.iconClass),i.style&&i.style.iconClass&&(s=i.style.iconClass),i.color&&(r=i.color),i.style&&i.style.color&&(r=i.style.color),s&&(e+='<li onclick="plotlist.startPlot('+a+',this)"><i title="'+i.name+'"  class="'+s+'" style="color:'+r+'"></i></li>')}}$("#plotlist").html(e)},_lastLi:null,startPlot:function(t,e){var a=$(e);a.addClass("markon"),this._lastLi&&this._lastLi.removeClass("markon"),this._lastLi=a;var l=this._listData[t],i=haoutil.system.clone(plotEdit.defval[l.type]||{});if(l.style)for(var n in l.style)i.style[n]=l.style[n];if(l.attr)for(var n in l.attr)i.attr[n]=l.attr[n];i.name=i.name||l.name,thisWidget.startDraw(i)},plotEnd:function(){this._lastLi&&this._lastLi.removeClass("markon")}},plotEdit={config:{},defval:{},loadConfig:function(){var t=this;$.getJSON("config/attr.json",function(e){t.config=e;for(var a in e){for(var l={},i=0;i<e[a].style.length;i++){var n=e[a].style[i];l[n.name]=n.defval}for(var s={},i=0;i<e[a].attr.length;i++){var n=e[a].attr[i];s[n.name]=n.defval}t.defval[a]={type:a,name:e[a].name,style:l,attr:s}}plotlist.bindSelList()})},_last_attr:null,startEditing:function(t,e){this._last_attr=t;var a=this.config[t.type];this.updateLatlngsHtml(e);for(var l=[],i="plot_attr_style_",n='<tr><td class="nametd">类型：</td><td>'+(a.name||t.name)+"</td></tr>",s=0;s<a.style.length;s++){var r=a.style[s];if("hidden"!=r.type){var o=r.name,d=t.style[o],c=this.getAttrInput(i,o,d,r);c.fun&&l.push({parname:i,name:o,value:d,edit:r,fun:c.fun}),n+='<tr  id="'+i+"tr_"+o+'" > <td class="nametd">'+r.label+"</td>  <td>"+c.html+"</td>  </tr>"}}$("#talbe_style").html(n),i="plot_attr_attr_",n="";for(var s=0;s<a.attr.length;s++){var r=a.attr[s];if("hidden"!=r.type){var o=r.name,d=t.attr[o],c=this.getAttrInput(i,o,d,r);c.fun&&l.push({parname:i,name:o,value:d,edit:r,fun:c.fun}),n+='<tr  id="'+i+"tr_"+o+'" > <td class="nametd">'+r.label+"</td>  <td>"+c.html+"</td>  </tr>"}}$("#talbe_attr").html(n);for(var s=0;s<l.length;s++){var p=l[s];p.fun(p.parname,p.name,p.value,p.edit)}tab2attr()},updateLatlngsHtml:function(t){var e="";if(t&&0!=t.length)if(1==t.length){var a=t[0],l=a.lng.toFixed(6),i=a.lat.toFixed(6);e+=' <div class="mp_attr" style=" margin-top: 10px;"><table> <tr> <td class="nametd">经度：</td> <td><input id="plot_attr_jd_'+n+'" type="number" class="mp_input" readonly="readonly" value="'+l+'"></td>  </tr> <tr>  <td class="nametd">纬度：</td> <td><input id="plot_attr_wd_'+n+'" type="number" class="mp_input" readonly="readonly" value="'+i+'"></td> </tr>  </table> </div>'}else for(var n=0;n<t.length;n++){var a=t[n],l=a.lng.toFixed(6),i=a.lat.toFixed(6);e+='<div><div class="open"><i class="tree_icon">-</i>第'+(n+1)+'点</div><div class="mp_attr"><table> <tr> <td class="nametd">经度：</td> <td><input id="plot_attr_jd_'+n+'" type="number" class="mp_input" readonly="readonly" value="'+l+'"></td>  </tr> <tr>  <td class="nametd">纬度：</td> <td><input id="plot_attr_wd_'+n+'" type="number" class="mp_input" readonly="readonly" value="'+i+'"></td> </tr>  </table> </div> </div>'}else;$("#view_latlngs").html(e),$("#view_latlngs .open").click(changeOpenShowHide)},stopEditing:function(){tab2plot(),$("#talbe_style").html(""),$("#talbe_attr").html(""),this._last_attr=null},getAttrInput:function(t,e,a,l){var i=this,n="",s=null;switch(l.type){default:case"label":n=a;break;case"text":n='<input id="'+t+e+'" type="text" value="'+a+'"   class="mp_input" />',s=function(t,e,a,l){$("#"+t+e).on("input propertychange",function(a){var l=$(this).val();i.updateAttr(t,e,l)})};break;case"textarea":a=a.replace(new RegExp("<br />","gm"),"\n"),n='<textarea  id="'+t+e+'"     class="mp_input" style="height:50px;resize: none;" >'+a+"</textarea>",s=function(t,e,a,l){$("#"+t+e).on("input propertychange",function(a){var l=$(this).val();0==l.length&&(l="文字"),l=l.replace(/\n/g,"<br />"),i.updateAttr(t,e,l)})};break;case"number":n='<input id="'+t+e+'" type="number" value="'+a+'"    class="mp_input"/>',s=function(t,e,a,l){$("#"+t+e).on("input propertychange",function(a){var l=Number($(this).val());i.updateAttr(t,e,l)})};break;case"combobox":n='<select id="'+t+e+'" class="mp_select"    data-value="'+a+'" >';for(var r=0;r<l.data.length;r++){var o=l.data[r];n+='<option value="'+o.value+'">'+o.text+"</option>"}n+="</select>",s=function(t,e,a,l){$("#"+t+e).select(),$("#"+t+e).change(function(){var a=$(this).attr("data-value");i.updateAttr(t,e,a)})};break;case"radio":n='<input   name="'+t+e+'" type="radio" value="1"  '+(a?'checked="checked"':"")+' style="width:15px;" >是  &nbsp;&nbsp; <input  name="'+t+e+'" type="radio" value="2"  '+(a?"":'checked="checked"')+' style="width:15px;" >否',s=function(t,e,a,l){$('input:radio[name="'+t+e+'"]').change(function(){var a="1"==$(this).val();i.updateAttr(t,e,a),i.changeViewByAttr(t,l.impact,a)}),i.changeViewByAttr(t,l.impact,a)};break;case"color":n='<input id="'+t+e+'" type="text" class="mp_input" style="width: 100%;"  value="'+a+'" />',s=function(t,e,a,l){$("#"+t+e).minicolors({position:"bottom right",control:"saturation",change:function(a,l){i.updateAttr(t,e,a)}})};break;case"slider":n='<input id="'+t+e+'"  type="text" value="'+100*a+'" />',s=function(t,e,a,l){var n=.7*$(".mp_tab_card").width()-30;$("#"+t+e).progress(n),$("#"+t+e).change(function(){var a=Number($(this).val())/100;i.updateAttr(t,e,a)})}}return{html:n,fun:s}},changeViewByAttr:function(t,e,a){if(e&&e.length>0)for(var l=0;l<e.length;l++){var i=e[l];a?$("#"+t+"tr_"+i).show():$("#"+t+"tr_"+i).hide()}},updateAttr:function(t,e,a){switch(t){case"plot_attr_style_":this._last_attr.style[e]=a;break;case"plot_attr_attr_":this._last_attr.attr[e]=a}thisWidget.updateAttr2map(this._last_attr)}};