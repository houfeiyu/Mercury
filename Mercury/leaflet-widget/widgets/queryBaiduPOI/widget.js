/* 2018-1-8 08:17:07 | 版权所有 合肥火星科技有限公司 http://www.marsgis.cn  【联系我们QQ：516584683】 */
var widget_queryBaiduPOI=L.widget.bindClass(L.widget.BaseWidget.extend({map:null,options:{resources:["view.css"],view:{type:"append",url:"view.html",parent:"body"}},configBaidu:{key:["5BdfbH8G0acGrG8bvauqkc6RClTe64fz"],url:"http://api.map.baidu.com/place/v2/search",region:"全国"},create:function(){var i=this;$.getJSON(this.path+"config.json",function(t){i.configBaidu=t})},winCreateOK:function(i,t){if("append"==i.type){var e=this;$("#map-querybar");var a=$("#map-querybar img");a.each(function(i,t){$(t).attr("src",e.path+$(t).attr("src"))}),e.config.position&&$("#map-querybar").css(e.config.position),e.config.style&&$("#map-querybar").css(e.config.style),$("#txt_querypoi").focus(function(){0==$.trim($(this).val()).length&&(e.hideAllQueryBarView(),e.showHistoryList())}),$("#txt_querypoi").bind("input propertychange",function(){e.hideAllQueryBarView(),e.clearLayers();var i=$.trim($("#txt_querypoi").val());0==i.length?e.showHistoryList():e.autoTipList(i,!0)}),$("#btn_querypoi").click(function(){e.hideAllQueryBarView();var i=$.trim($("#txt_querypoi").val());e.strartQueryPOI(i,!0)}),$("#txt_querypoi").bind("keydown",function(i){"13"==i.keyCode&&$("#btn_querypoi").click()}),$("#querybar_detail_back").click(function(){e.hideAllQueryBarView(),$("#querybar_resultlist_view").show()})}},activate:function(){this.map.on("click",this.map_clickHandler,this)},disable:function(){this.map.off("click",this.map_clickHandler,this)},map_clickHandler:function(){0==$.trim($("#txt_querypoi").val()).length&&this.hideAllQueryBarView()},hideAllQueryBarView:function(){$("#querybar_histroy_view").hide(),$("#querybar_autotip_view").hide(),$("#querybar_detail_view").hide(),$("#querybar_resultlist_view").hide()},autoSearch:function(i){$("#txt_querypoi").val(i),$("#btn_querypoi").trigger("click")},_key_index:0,getKey:function(){var i=this._key_index++%this.configBaidu.key.length;return this.configBaidu.key[i]},autoTipList:function(i,t){if(this.hasExWidget()&&t){this.autoExTipList(i)}else{var e=this.getKey();$.ajax({url:this.configBaidu.url,type:"GET",dataType:"jsonp",async:!1,timeout:"5000",contentType:"application/json;utf-8",data:{output:"json",ak:e,scope:1,page_size:10,page_num:0,query:i,city_limit:!0,region:this.configBaidu.region},success:function(i){if(0!==i.status)return void haoutil.msg("请求失败("+i.status+")："+i.message);for(var t=i.results,e="",a=0;a<t.length;a++){var s=t[a].name,r=t[a].num;r>0||(e+="<li><a href=\"javascript:widget_queryBaiduPOI.autoSearch('"+s+"');\">"+s+"</a></li>")}e.length>0&&($("#querybar_ul_autotip").html(e),$("#querybar_autotip_view").show())},error:function(i){haoutil.msg("请求出错("+i.status+")："+i.statusText)}})}},queryText:null,queryRegion:null,strartQueryPOI:function(i,t){if(0==i.length)return void haoutil.msg("请输入搜索关键字！");if(this.addHistory(i),this.hideAllQueryBarView(),this.hasExWidget()&&t){this.queryExPOI(i)}else this.thispage=1,this.queryText=i,this.queryRegion=this.configBaidu.region,this.queryPOI()},queryPOIForCity:function(i){this.thispage=1,this.queryRegion=i,this.queryPOI()},queryPOI:function(){var i=this,t=this.getKey();$.ajax({url:this.configBaidu.url,type:"GET",dataType:"jsonp",async:!1,timeout:"5000",contentType:"application/json;utf-8",data:{output:"json",ak:t,scope:2,page_size:this.pageSize,page_num:this.thispage-1,query:this.queryText,region:this.queryRegion},success:function(t){if(i.isActivate){if(0!==t.status)return void haoutil.msg("请求失败("+t.status+")："+t.message);var e=t.results;e&&e.length>0&&e[0].num>0?i.workShowCitys.showResult(e):i.showPOIPage(e,t.total)}},error:function(i){haoutil.msg("请求出错("+i.status+")："+i.statusText)}})},workShowCitys:{pageSize:10,arrdata:[],counts:0,allpage:0,thispage:0,showResult:function(i){this.arrdata=i,this.counts=i.length,this.allpage=Math.ceil(this.counts/this.pageSize),this.thispage=1,this.showPOIPage()},showPOIPage:function(){var i="",t=(this.thispage-1)*this.pageSize,e=t+this.pageSize;e>=this.counts&&(e=this.counts);for(var a=t;a<e;a++){var s=this.arrdata[a];s.index=a+1;var r=s.name;i+='<div class="querybar-site" onclick="widget_queryBaiduPOI.queryPOIForCity(\''+r+'\')"> <div class="querybar-sitejj"> <div style=" float: left;">'+r+'</div> <div style=" float: right;  ">约'+s.num+"个结果</div></div> </div>"}i+='<div class="querybar-page"><div class="querybar-fl">找到<strong>'+this.counts+'</strong>个结果</div><div class="querybar-ye querybar-fr">'+this.thispage+"/"+this.allpage+'页  <a href="javascript:widget_queryBaiduPOI.workShowCitys.showFirstPage()">首页</a> <a href="javascript:widget_queryBaiduPOI.workShowCitys.showPretPage()">&lt;</a>  <a href="javascript:widget_queryBaiduPOI.workShowCitys.showNextPage()">&gt;</a> </div></div>',$("#querybar_resultlist_view").html(i),$("#querybar_resultlist_view").show()},showFirstPage:function(){this.thispage=1,this.showPOIPage()},showNextPage:function(){this.thispage=this.thispage+1,this.thispage>this.allpage&&(this.thispage=this.allpage),this.showPOIPage()},showPretPage:function(){this.thispage=this.thispage-1,this.thispage<1&&(this.thispage=1),this.showPOIPage()}},pageSize:6,arrdata:[],counts:0,allpage:0,thispage:0,showPOIPage:function(i,t){this.arrdata=i,this.counts=t,this.counts<i.length&&(this.counts=i.length),this.allpage=Math.ceil(this.counts/this.pageSize);var e="";if(0==this.counts)e+='<div class="querybar-page"><div class="querybar-fl">没有找到"<strong>'+this.queryText+'</strong>"相关结果</div></div>';else{for(var a=0;a<this.arrdata.length;a++){var s=this.arrdata[a],r=(this.thispage-1)*this.pageSize;s.index=r+(a+1);var o=a,h=s.name;e+='<div class="querybar-site" onclick="widget_queryBaiduPOI.showDetail(\''+o+'\')"> <div class="querybar-sitejj"> <h3>'+s.index+"、"+h+"</h3> <p>"+(s.address||"")+"</p> </div> </div>",this.objResultData[o]=s}var n;n=this.allpage>1?'<div class="querybar-ye querybar-fr">'+this.thispage+"/"+this.allpage+'页  <a href="javascript:widget_queryBaiduPOI.showFirstPage()">首页</a> <a href="javascript:widget_queryBaiduPOI.showPretPage()">&lt;</a>  <a href="javascript:widget_queryBaiduPOI.showNextPage()">&gt;</a> </div>':"",e+='<div class="querybar-page"><div class="querybar-fl">找到<strong>'+this.counts+"</strong>条结果</div>"+n+"</div>"}$("#querybar_resultlist_view").html(e),$("#querybar_resultlist_view").show(),this.showPOIArr(this.arrdata),1==this.counts&&this.showDetail("0")},showFirstPage:function(){this.thispage=1,this.queryPOI()},showNextPage:function(){return this.thispage=this.thispage+1,this.thispage>this.allpage?(this.thispage=this.allpage,void haoutil.msg("当前已是最后一页了")):void this.queryPOI()},showPretPage:function(){return this.thispage=this.thispage-1,this.thispage<1?(this.thispage=1,void haoutil.msg("当前已是第一页了")):void this.queryPOI()},objResultData:{},showDetail:function(i){$("#querybar_resultlist_view").hide(),$("#querybar_detail_view").show();var t=this.objResultData[i],e=t.name;e.length>12&&(e=e.substring(0,11)+".."),$("#lbl_poi_name").html(e);var a="<p>名称："+t.name+"</p>";t.telephone&&(a+="<p>电话："+t.telephone+"</p>"),t.address&&(a+="<p>地址："+t.address+"</p>"),t.detail_info&&t.detail_info.tag&&(a+="<p>类别："+t.detail_info.tag+"</p>"),$("#poi_detail_info").html(a),t.detail_info&&t.detail_info.detail_url?($("#btnShowDetail").show(),$("#btnShowDetail").attr("href",t.detail_info.detail_url)):$("#btnShowDetail").hide(),t.layer?this.centerAt(t.layer):haoutil.msg('"'+e+'"无地理坐标信息！')},layerWork:null,getWorkLayer:function(){return null==this.layerWork&&(this.layerWork=L.markerClusterGroup({chunkedLoading:!0,spiderfyOnMaxZoom:!0,disableClusteringAtZoom:17}).addTo(this.map)),this.layerWork},clearLayers:function(){null!=this.layerWork&&this.layerWork.clearLayers()},showPOIArr:function(i){var t=this,e=this.getWorkLayer();e.clearLayers(),$.each(i,function(i,a){var s=a.location.lng,r=a.location.lat;if(s>0&&r>0){var o,h=L.mars.pointconvert.bd2wgs([s,r]);s=h[0],r=h[1],o=t.map.convert2map([r,s]);var n=L.marker(o,{icon:L.icon({iconUrl:t.path+"images/poi.png",iconSize:[16,16],iconAnchor:[8,8],popupAnchor:[0,-8]})});n.attributes=a;var u;u=a.detail_info&&a.detail_info.detail_url?'<a href="'+a.detail_info.detail_url+'"  target="_black" style="color: #ffffff; ">'+a.name+"</a>":a.name;var l='<div class="mars-popup-titile">'+u+'</div><div class="mars-popup-content" >',c=$.trim(a.telephone);""!=c&&(l+="<div><label>电话</label>"+c+"</div>");var d=$.trim(a.address);if(""!=d&&(l+="<div><label>地址</label>"+d+"</div>"),a.detail_info){var g=$.trim(a.detail_info.tag);""!=g&&(l+="<div><label>类别</label>"+g+"</div>")}l+="</div>",n.bindPopup(l),e.addLayer(n),a.layer=n}}),e.getLayers().length>0&&this.map.fitBounds(e.getBounds())},centerAt:function(i){var t=i.getLatLng();this.map.centerAt(t),i.openPopup()},cookieName:"querypoi_gis",arrHistory:[],showHistoryList:function(){$("#querybar_histroy_view").hide();var lastcookie=haoutil.cookie.get(this.cookieName);if(null!=lastcookie&&(this.arrHistory=eval(lastcookie),null!=this.arrHistory&&0!=this.arrHistory.length)){for(var inhtml="",index=this.arrHistory.length-1;index>=0;index--){var item=this.arrHistory[index];inhtml+="<li><a href=\"javascript:widget_queryBaiduPOI.autoSearch('"+item+"');\">"+item+"</a></li>"}$("#querybar_ul_history").html(inhtml),$("#querybar_histroy_view").show()}},clearHistory:function(){this.arrHistory=[],haoutil.cookie.del(this.cookieName),$("#querybar_ul_history").html(""),$("#querybar_histroy_view").hide()},addHistory:function(data){this.arrHistory=[];var lastcookie=haoutil.cookie.get(this.cookieName);null!=lastcookie&&(this.arrHistory=eval(lastcookie)),this.arrHistory.remove(data),this.arrHistory.push(data),this.arrHistory.length>10&&this.arrHistory.splice(0,1),lastcookie=JSON.stringify(this.arrHistory),haoutil.cookie.add(this.cookieName,lastcookie)},exWidget:null,hasExWidget:function(){return!1},autoExTipList:function(i){var t=this;this.exWidget.autoTipList(i,function(){t.autoTipList(i,!1)})},queryExPOI:function(i){var t=this.getWorkLayer(),e=this;this.exWidget.strartQueryPOI(i,t,function(){e.strartQueryPOI(i,!1)})}}));